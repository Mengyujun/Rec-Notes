# 用户行为序列建模



**用户行为序列建模** -- 即通过序列模型来建模用户的行为序列，得出用户的实时兴趣向量 （user's interest vector)，进而应用到排序系统的召回和排序模块中，为用户提供个性化的服务。



## 用户行为序列建模主要工作

在深度学习时代，主流的用户行为序列建模主要有以下22个模型：

![image-20210309141255561](https://i.loli.net/2021/03/09/56eaOpUlYHEMr2L.png)

按时间线来看，用户行为序列建模的模型经历了**polling, attention, RNN, Capsule，Transformer**的发展路线。

目前，**基于Transformer的行为序列**已经成为工业界搜索推荐用户行为序列建模的主流。



**不同角度**来比较目前的用户序列建模模型



### 行为序列的时间窗口

已有工作建模的用户序列的时间窗口包括**近期、长期、session**级别。

- 近期序列 最常见（DNN， DIN， DIEN） 最近几天，几周， 几月的行为序列， 通常聚焦在一个或几个类目上
- 长期序列 （MIMN，SIM, DMT , AliSearch ） 通常包括多个类目，反映了用户的类目、品牌、风格、价格区间、店铺、物流偏好等信息。
- Session序列 每次访问一次APP的 序列信息  （DSIN， TISSA） 关注于将用户的每次访问内的行为看作一个session内的行为序列，再建模多次访问的多个session序列



### 用户序列行为的属性信息

即 在用户行为建模中使用的 特征有哪些？

- **物品id**： 如sku-id
- **物品属性信息**： 如 二级分类， 三级分类，shopid    brand 如点击商品的品牌，店铺 标题等信息 
- **行为时间信息**：点击商品的时间到当前排序时间的时间差
- **行为类型：**例如商品上的行为是点击，加购，收藏，购买等 
- **行为的详细信息：**例如点击商品后的停留时长，是否点击图片，是否查看评论等。已有工作包括AliSearch , HUP等。



### 多种行为序列混合

按照行为的**时间窗口、行为类型**，可以构造多个行为序列。通常包括：**近期/长期 点击/收藏/加购/购买** 序列，**搜索query序列，最近曝光未点击的序列**等。

即得到多种不同序列之后，再模型中的使用（**建模多序列**）：

- **混合建模**, AliSearch 将近期的多种序列混合起来，按时间排序，形成一个混合序列。
- **独立建模** JD的DMT 不同序列分别建模 得到多个兴趣向量 



### 负反馈序列建模

主要包括 显示负反馈和隐式负反馈，（AliSearch ，DFN，FINN， DSTN）建模负反馈序列，提升用户体验 





## 用户行为序列建模模型详细介绍

按照已有序列建模工作基于的**机器学习模型进行分类**，详细介绍已有的用户行为序列建模模型。



### Pooling 

基于Pooling的方法建模行为序列的工作，主要包括 **youtube- DNN** 

通常采用**mean**, **sum** 或 **max pooling**的方法聚合用户的行为序列，它们将用户的历史序列中的行为看得同等重要，因此pooling的结果反映了**用户的主要兴趣**。

 DNN [1] （Recsys'16）通过基于pooling的操作建模用户的搜索序列、观看视频序列，应用在Google Youtube的视频推荐系统的召回和排序模块中。

​    在召回模块的模型如下图所示，使用了观看视频序列、搜索序列：

![image-20210309151817277](https://i.loli.net/2021/03/09/U4RxGBPZMpfl52v.png)

​     在排序模块的模型如下图所示，使用了观看视频序列：

![图片](https://i.loli.net/2021/03/09/F2bEwcDS3snm9hM.png)



### Attention

pooling方法的缺点： 

- 用户历史行为中的物品的重要性看做是相同的， 无法区分不同商品的不同重要性（如时间限制的）
- 对不同的待打分item， 用户的兴趣向量是相同的， 无法建模多兴趣

为解决以上问题， 提出了attention的方法来建模行为序列， 主要有**DIN， DSTN** 



**DIN** 

基于attention建模用户的商品点击行为序列， 

![image-20210309152656375](https://i.loli.net/2021/03/09/DV4lTof51CEuar7.png)

左侧为base模型， 即经典的embedding+ mlp (对用户历史访问商品 的 类别id， 商店id，商品id做embedding之后做concat+ sum pooling)

右侧为din模型:

- 对于每个待排序的广告， 需要计算出每个历史点击的商品和待排序广告的**attention score,** 作为这个历史行为的**权重**，然后基于这些权重，将历史行为序列物品的embedding，聚合成一个用户兴趣向量。 注意还是有 sum-pooling 只是不同历史点击的权重现在是自适应变化的 
- 对于 attention-score的计算  没有使用softmax ？  待补充



### RNN 

pooling和attention的不足：

-  无法建模用户历史行为的时间信息， 近期行为对当前item 应当有更大的权重
- 没有时间信息， 无法建模用户兴趣的不断演化 

为解决上述问题， 提出了基于RNN建模行为序列，主要包括 **GRU4Rec , DIEN, DUPN , HUP, DHAN**等。它们通过RNN建模行为序列的时间顺序特性，能更好地建模用户实时兴趣的变化。



**DIEN**

基于**双层RNN**来建模用户的商品点击序列

![image-20210309155338566](https://i.loli.net/2021/03/09/v1ZWqoJRUkeQVFa.png)

待补充 



**京东HUP**



### **Capsule**

存在的问题： **召回阶段,** 基于之前的pooling， attention，rnn建模出的用户兴趣向量，通过faiss查找最近的邻居商品，**召回的商品都很相似**，无法满足搜索推荐**多样性**的需求。

提出基于Capsule建模行为序列，主要包括 **MIND， ComiRec**



**MIND**

基于Capsule建模用户的行为序列向量，应用在天猫推荐的**召回模块**中。

![image-20210309203044613](https://i.loli.net/2021/03/09/Wx9YNmrABcQdhl6.png)



### Transformer

基于RNN的序列建模模型的缺陷：

- 无法有效建模**长序列、长依赖**（RNN本身的问题）
- 无法建模- 行为序列内**多个行为彼此间的关联关系**。

提出了 基于transformer建模行为序列，主要包括ATRank , **BST**, **DSIN** , TISSA, SDM , KFAtt , **DFN** , SIM , **DMT** , AliSearch   等



**DMT**

基于**多个Transformer**分别建模用户的**点击、加购、购买商品序列**

使用**MMoE**建模点击预测、购买预测多个任务，同时使用**Bias DNN**消除反馈数据中的bias 

建模用户序列： 包括encoder和decoder。其中encoder建模行为序列中多个行为彼此间的管理关系，对于每个待排序商品，decoder解码出不同的用户兴趣向量，从而能够建模用户的多兴趣。

![image-20210309210059312](https://i.loli.net/2021/03/09/r8KepGsQaHbZEin.png)